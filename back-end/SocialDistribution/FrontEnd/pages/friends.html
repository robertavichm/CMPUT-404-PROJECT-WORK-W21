{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet"  href="{%  static  'css/frame_.css'  %}">
    <link rel="stylesheet"  href="{%  static  'css/friends.css'  %}">
    <link href = "https://fonts.googleapis.com/css?family=Roboto+Mono|Roboto+Slab|Roboto:300,400,500,700" rel = "stylesheet" />
    <title>Friends</title>

</head>
<body>
   {% include "components/topnav.html" %}
    <div class="main-body">
        {% include "components/leftnav.html" %}

        <div class="content">
            <div class="content-aligner">
                <div class="friend-request-wrap">
                    <div class="friend-r-inner">
                        <div class="f-head">
                            <p>Follower requests</p>
                            <div class="arrow-down" id="request-arrow">
                                <i class="material-icons" style="color:rgba(0,0,0,0.50)">arrow_downward</i>
                            </div>
                        </div>
                        <div class="friend-r-body">
                            <table id="friend-request-table">
                                <tbody class="f-req-body">
                                    <tr>
                                        <td>sample friend request</td>
                                        <td><div class="accept_btn">Accept</div></td>
                                        <!-- <td><div class="decline_btn">Decline</div></td> -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="friends-wrap">

                        <div class="f-head">
                            <p>Friends</p>
                            <div class="arrow-down" id="friends-arrow">
                                <i class="material-icons" style="color:rgba(0,0,0,0.50)">arrow_downward</i>
                            </div>
                        </div>
                        <div class="friends-w-body">

                                <table id="friends-table">
                                    <tbody class="f-body">
                                        <tr>
                                            <td>sample friend</td>
                                            <td><div class="remove_btn">Remove</div></td>
                                        </tr>
                                    </tbody>
                                </table>
                        </div>
                </div>

                <div class="friends-wrap">

                        <div class="f-head">
                            <p>Followers</p>
                            <div class="arrow-down  foll-w" id="friends-arrow">
                                <i class="material-icons" style="color:rgba(0,0,0,0.50)">arrow_downward</i>
                            </div>
                        </div>
                        <div class="friends-w-body">

                                <table id="followers-table">
                                    <tbody class="followers-body">
                                        <tr>
                                            <td>sample follower</td>
                                            <td><div class="remove_btn">Remove</div></td>
                                        </tr>
                                    </tbody>
                                </table>
                        </div>
                </div>
            </div>

        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="{% static 'common.js' %}"></script>
    <script>

        const host_url = '{{ host_url }}';

        // grabbing credentials from localStorage
        const username = localStorage.getItem("username");
        const password = localStorage.getItem("pwd");
        const uuid  = localStorage.getItem("uuid");

        // Opens/Closes 'Friend request' tab
        var toggle_f_r = 0;
        $('#request-arrow').click(function() {
            if(toggle_f_r == 0){
                document.getElementsByClassName('friend-r-body')[0].style.display = "inline-block";
                document.getElementsByClassName('friend-request-wrap')[0].classList.add("open");
                document.getElementsByClassName('friend-r-inner')[0].classList.add("open");
                toggle_f_r = 1;
            }else{
                document.getElementsByClassName('friend-r-body')[0].style.display = "none";
                document.getElementsByClassName('friend-request-wrap')[0].classList.remove("open");
                document.getElementsByClassName('friend-r-inner')[0].classList.remove("open");
                toggle_f_r = 0;
            }

        });

        // Opens/Closes 'Friend' tab
        var toggle_f = 0;
        $('#friends-arrow').click(function() {
            if(toggle_f == 0){
                document.getElementsByClassName('friends-w-body')[0].style.display = "inline-block";
                document.getElementsByClassName('friends-wrap')[0].classList.add("open-f");
                toggle_f = 1;
            }else{
                document.getElementsByClassName('friends-w-body')[0].style.display = "none";
                document.getElementsByClassName('friends-wrap')[0].classList.remove("open-f");
                toggle_f = 0;
            }
        });

        // Opens/Closes 'Followers' tab
        var toggle_ff = 0;
        $('.foll-w').click(function() {
            if(toggle_ff == 0){
                document.getElementsByClassName('friends-w-body')[1].style.display = "inline-block";
                document.getElementsByClassName('friends-wrap')[1].classList.add("open-f");
                toggle_ff = 1;
            }else{
                document.getElementsByClassName('friends-w-body')[1].style.display = "none";
                document.getElementsByClassName('friends-wrap')[1].classList.remove("open-f");
                toggle_ff = 0;
            }
        });

        // GET Friend requests from inbox
        $.ajax({
          type: 'GET',
          headers: {
              'Authorization': 'Basic ' + btoa(username+':'+password),
          },
          url: host_url + 'author/'+ localStorage.getItem('uuid') +'/inbox/',
          dataType: 'json',
        })
          .done(function(data){
            console.log(data.items)
            var fr_req = []; // IDs and dname of requesters

            for(el of data['items']){

              if(el.type === "follow"){
                var d = {
                  'id': el.author_id.id,
                  'displayName': el.author_id.displayName,
                  'notif_id': el.notif_id, // used to delete item from inbox once approved
                }
                fr_req.push(d);
              }
            }

            formatAndAppendFriendRequests(fr_req);

          });

          // Append friend request data to DOM
          function formatAndAppendFriendRequests(fr_req){
            for(fr of fr_req){
              $('.f-req-body').append(`
                <tr>
                    <td>${fr.displayName}</td>
                    <td><div data-id="${fr.id}" data-notif-id="${fr.notif_id}"class="accept_btn">Accept</div></td>
                </tr>
                `);
            }
          }

          // GET Followers
          $.ajax({
            type: 'GET',
            url: host_url + 'author/'+ localStorage.getItem('uuid') +'/followers/',
            dataType: 'json',
          })
            .done(function(data){
              const followers = []; // IDs and dname of followers

              for(el in data['items']){
                var d = {
                  'id': data['items'][el].id,
                  'displayName': data['items'][el].displayName,
                }
                  followers.push(d);
              }

              formatAndAppendFollowers(followers);
              getFriends(followers);
            });


            // Append Followers data to DOM
            function formatAndAppendFollowers(followers){
              for(f of followers){
                $('.followers-body').append(`
                  <tr>
                      <td>${f.displayName}</td>
                      <td><div data-id="${f.id}"  class="remove_btn">Remove</div></td>
                  </tr>
                  `);
              }
            }

            // 'Accept' follow request
            $('#friend-request-table').on('click', '.accept_btn', function(){
                const follower_id = $(this).data("id");
                const notif_id  = $(this).data("notif-id");

                $.ajax({
                  type: 'PUT',
                  headers: {
                      'Authorization': 'Basic ' + btoa(username+':'+password),
                  },
                  url: host_url + 'author/'+ localStorage.getItem('uuid') +'/followers/'+ follower_id + '/',
                  // dataType: 'json',
                })
                  .done(function(data){
                    // remove notification from inbox
                    console.log('inside first layer');
                    $.ajax({
                      type: 'DELETE',
                      headers: {
                          'Authorization': 'Basic ' + btoa(username+':'+password),
                      },
                      url: host_url + 'author/'+ localStorage.getItem('uuid') +'/inbox/'+ notif_id + '/',
                    })
                      .done(function(data){
                        location.reload();
                      });
                  });
            });

            // TODO: decline follower request


            // 'Remove' follower
            // TODO: URL Not Found
            $('#followers-table').on('click', '.remove_btn', function(){
                const follower_id = $(this).data("id");

                $.ajax({
                  type: 'DELETE',
                  headers: {
                      'Authorization': 'Basic ' + btoa(username+':'+password),
                  },
                  url: host_url + 'author/'+ localStorage.getItem('uuid') +'/followers/'+ follower_id,
                })
                  .done(function(data){
                    // TODO: Not working
                    location.reload();
                  });
            });

            // GET Friends
            // 1. Get all followers
            // 2. Check if request was accepted
            function getFriends(followers){
              // for every follower,
              // check if other author also follows
              for(f of followers){
                $.ajax({
                  type: 'GET',
                  url: host_url + 'author/'+ localStorage.getItem('uuid') + '/followers/' + f.id,
                  dataType: 'json',
                })
                  .done(function(data){
                    console.log(f.displayName, data.friends)
                    if(data.friends){
                      $('.f-body').append(`
                        <tr>
                            <td>${f.displayName}</td>
                        </tr>
                        `);
                    }
                  });
              }
            }



    </script>
</body>
</html>
