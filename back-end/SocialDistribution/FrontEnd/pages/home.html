{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" type="text/css" href="{% static 'css/home.css' %}">
    <link rel="stylesheet"  href="{%  static  'css/frame_.css'  %}">
    <link href = "https://fonts.googleapis.com/css?family=Roboto+Mono|Roboto+Slab|Roboto:300,400,500,700" rel = "stylesheet" /><link href = "https://fonts.googleapis.com/css?family=Roboto+Mono|Roboto+Slab|Roboto:300,400,500,700" rel = "stylesheet" />
    <title>Home</title>
    <style>
        .inbox-wrap{
            display:none;
        }

        .send-comment{
            width:50px;
            height:40px;
            float:right;
            margin-top:-40px;
            margin-right:20px;
            border-radius: 0 25px 25px 0;
            background-color:rgba(0,0,0,0.10);
            display:flex;
            justify-content:center;
            align-items:center;
            cursor:pointer;
        }
        .send-comment:hover{
            background-color:rgba(0,0,0,0.20);
        }
        .o-r-cell{
            margin-top:10px;
            background-color:white;
        }
        .o-r-details{
            word-wrap:break-word;
            padding-bottom:5px;
            background-color:rgba(0,0,0,0.02);
            border-bottom:1px solid rgba(0,0,0,0.03);
        }
        .o-r-details span{
            color:cornflowerblue;
        }
        .o-r-details p{
            width:100%;
            padding-left:10px;
            padding-right:10px;
            padding-top:5px;
            box-sizing: border-box;
            color:rgba(0,0,0,0.75);
        }
        .c-p-wrap{
            line-height:20px;
            height:25px;
        }
        .c-p-wrap p{
            font-size:14px;
            padding:0;
            margin-top:2.5px;
            padding-left:10px;
            text-align:left;
        }
        .comment-profile{
            width:20px;
            height:20px;
            float:left;
            display:flex;
            justify-content: center;
            align-items: center;
            margin-top:2.5px;
            margin-left:10px;
            margin-right:5px;
            border-radius:10px;
            background-color:cornflowerblue;
        }

        .comment-like-wrap{
            height:100%;
            float:left;
            width:45px;
        }
        .comment-like-wrap:hover{
            background-color:rgba(0,0,0,0.25);
        }
        .comment-like-num{
            height:100%;
            float:left;
        }

        .comment-time{
            height:30px;
            margin-top:-45px;
            margin-right:10px;
            float:right;line-height:30px;
        }
        .comment-time p{
            margin-top:0;
            margin-top:5px;

        }
        #com-like{
            padding-left:0;
         }
        .unhideDel,.unhideEdit{

        }
        .hideDel,.hideEdit{
            display:none;
        }
        .outside-post {
          width:50px;
          height: 100%;
          background-color: rgba(0,0,0,0.03);
          float:right;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .nodiscoveries{
            display: none;
            width:calc(100% - 10px);
            margin-left:5px;
            margin-top:10px;
            margin-bottom:10px;
            height:120px;
            background-color: antiquewhite;

        }
        .popup-auth{
            width:400px;
            height:200px;
            top:calc(30%);
            left:calc(50% - 50px);
            position: absolute;
            z-index:99;
            display:none;
            background-color:white;
            box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;
        }
        .pop-up-head{
            height:39px;
            border-bottom:1px solid rgba(0,0,0,0.05);
        }
        .popup-close{
            float:right;
            height:100%;
            width:40px;
            display:flex;
            align-items: center;
            justify-content: center;
            cursor:pointer;
            background-color:rgba(0,0,0,0.05);
        }
        .popup-close:hover{
            background-color:rgba(0,0,0,0.2);
        }
        .popup-body{
            height:calc(100% - 90px);
            display:flex;
            justify-content:center;
            align-items:center;
        }
        .popup-body h3{
            margin-top:0;
            font-size:16px;
            font-weight:600;
            color:rgba(0,0,0,0.75);
        }
        .pop-up-action{
            height:49px;
            border-top:1px solid rgba(0,0,0,0.05);
        }
        .signin-act{
            width:calc(50% - 1px);
            height:40px;
            margin-top:5px;
            float:left;
            border-right:1px solid rgba(0,0,0,0.20);
            background-color:white;
            cursor:pointer;
            color:rgba(0,0,0,0.50);
            line-height:40px;
        }
        .signup-act{
            width:50%;
            height:40px;
            margin-top:5px;
            float:right;
            cursor:pointer;
            line-height:40px;
            color:rgba(0,0,0,0.50);
            background-color:white;
        }
        .signup-act:hover,.signin-act:hover{
            background-color:darkcyan;
            color:white;
        }
        .signin-act p,.signup-act p{
            margin:0;
            text-align:center;
        }
        #show_img_block{
            display:flex;
        }
        #hide_img_block{
            display:none;
        }
        #show_post_text{
            display:block;
        }
        #hide_post_text{
            display:none;
        }
        .p-title-wrap h3{
            font-size:18px;
            font-weight:600;
            margin-left:10px;
            color:rgba(0,0,0,0.75);
        }
        .comment-tzone{
            height:100%;
            float:right;
            margin-right:10px;
        }
    </style>
</head>
<body>
    <body>
      {% include "components/topnav.html" %}
        <div class="main-body">
              {% include "components/leftnav.html" %}
            <div class="content">

                <div id="post-top-container">
                  <div id="post-input-w"><input id="post-input" type="text" placeholder="What's on your mind?" ></div>

                  <div id="post-container" >
                    <div class="p-f-h">
                        <div class="close">
                            <i class="material-icons">close</i>
                        </div>
                        <div class="tab-control">
                            <div class="post-raw">
                                <p>Write</p>
                            </div>
                            <div class="post-preview">
                                <p>Preview</p>
                            </div>
                        </div>
                    </div>

                    <!-- Markdown Preview -->
                    <div class="preview-body">

                    </div>

                    <div class="post-body">
                      <div class="post-main" style="text-align:center">
                        <div class="p-content-title">
                            <input type="text" placeholder="title..." id="p-title">
                        </div>

                        <textarea id="p-r-text-input" cols="30" rows="5" placeholder="Start a conversation ..."></textarea>

                        <div class="p-categories" style="margin-top:10px">
                            <input type="text" placeholder="food,school" id="p-cat" style="height: 20px !important;padding: 3px;font-size: 0.89em;">
                        </div>

                        <div class="post-main-bot">
                          <div class="post-images">
                              <input type="file" id="img-input"/>
                              <div class="img-logo-wrap">
                                  <i class="material-icons">wallpaper</i>
                              </div>
                              <p class="img-logo-text" style="margin:0;margin-top:12.5px;float:left">Photo</p>
                          </div>


                          <div class="sel">
                            <select  id="content_type">
                               <option value="text/plain">Plain text</option>
                               <option value="text/markdown">Markdown</option>
                             </select>
                          </div>
                          <div class="sel">
                            <select id="visibility_choice">
                              <option value="PUBLIC">Public</option>
                              <option value="FRIENDS">Friends</option>
                             </select>
                          </div>
                          <div class="sel">
                            <select id="whichFriend" disabled>
                              <option value="ALL">All</option>
                             </select>
                          </div>
                          <div class="sel">
                            <select id="unlisted_listed">
                              <option value="Listed">Listed</option>
                              <option value="Unlisted">Unlisted</option>
                             </select>
                          </div>
                          <div class="create-post">
                              <p>Post</p>
                          </div>
                        </div>

                      </div>

                      <div class="post-img">
                        <div class="post-img-h">
                          <img id="img-preview">
                        </div>
                        <div class="p-close-img">
                          <i class="material-icons" style="color:black">close</i>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>

                <div class="popup-auth">
                    <div class="pop-up-head">
                        <div class="popup-close"><i class="material-icons" style="color:rgba(0,0,0,0.50)">close</i></div>
                    </div>
                    <div class="popup-body">
                        <h3>You must be authenticated to use this feature</h3>
                    </div>
                    <div class="pop-up-action">
                        <div class="signin-act"><p>Sign In</p></div>
                        <div class="signup-act"><p>Sign Up</p></div>
                    </div>
                </div>

                <div class="post-feed-w">
                    <div class="post-feed">
                        <div class="tab-switch" style="width:100%;">
                            <div class="tab-public" style="width:110px;">
                                <div class="tab-icon"><i class="material-icons" style="color:rgba(0,0,0,0.50)">public</i></div>
                                <div class="tab-text"><p>Local</p></div>
                            </div>
                            <div class="tab-inbox">
                                <div class="tab-icon"><i class="material-icons" style="color:rgba(0,0,0,0.50)">inbox</i></div>
                                <div class="tab-text"><p>Foreign</p></div>
                            </div>
                        </div>
                        <div class="nodiscoveries">
                            <lottie-player src="{%  static  'disc.json'  %}" background="transparent" speed="1.5" loop autoplay>

                            </lottie-player>
                        </div>
                        <div class="inbox-wrap" style="background-color: aqua;">
                            <div class="table-head">
                                <p>Summary</p>
                            </div>
                            <div class="table-body">

                                <table id="summary-table">
                                    <tbody id="sum-body">

                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- =============================== Editing Post Block =============================== -->

                        <div class="e-editPostPopup" style="border: 1px solid #00000061">
                          <div class="e-w-popup">

                            <div class="e-p-f-h">
                                <div class="e-close" onclick="closeEditFormPopup()">
                                    <i class="material-icons">close</i>
                                </div>
                                <div class="e-tab-control">
                                    <div class="e-post-raw">
                                        <p>Write</p>
                                    </div>
                                    <div class="e-post-preview">
                                        <p>Preview</p>
                                    </div>
                                </div>
                            </div>

                            <div class="e-post-body">
                              <div class="e-post-main" style="text-align:center">
                                <div class="e-p-content-title">
                                    <input type="text" placeholder="title..." id="e-p-title">
                                </div>
                                <div class="e-p-content-desc" style="display:none">
                                    <input type="text" placeholder="decription..." id="e-p-description">
                                </div>
                                <textarea id="e-p-r-text-input" cols="30" rows="5" placeholder="Start a conversation ..."></textarea>

                                <div class="e-post-main-bot">
                                  <div class="e-post-images">
                                      <input type="file" id="e-img-input"/>
                                      <div class="e-img-logo-wrap">
                                          <i class="material-icons">wallpaper</i>
                                      </div>
                                      <p class="e-img-logo-text" style="margin:0;margin-top:12.5px;float:left">Photo</p>
                                  </div>


                                  <div class="e-sel">
                                    <select  id="e-content_type">
                                       <option value="text/plain">Plain text</option>
                                       <option value="text/markdown">Markdown</option>
                                     </select>
                                  </div>
                                  <div class="e-sel">
                                    <select id="e-visibility_choice">
                                      <option value="PUBLIC">Public</option>
                                      <option value="FRIENDS">Friends</option>
                                     </select>
                                  </div>
                                  <div class="e-sel">
                                    <select id="e-one_friend">
                                      <option value="FRIENDS">Friends</option>
                                     </select>
                                  </div>
                                  <div class="e-sel">
                                    <select id="e-unlisted_listed">
                                      <option value="Listed">Listed</option>
                                      <option value="Unlisted">Unlisted</option>
                                     </select>
                                  </div>
                                  <div class="e-create-post">
                                      <!-- We send over some data. Avoids making a second call to author/{author_id}/posts/{post_id}/  -->
                                      <input id="e-data-holder" type="hidden" data-id="" data-source="" data-origin="" data-commentLink="" data-commentCount="">
                                      <p>Post</p>
                                  </div>
                                </div>

                              </div>

                              <div class="e-post-img">
                                <div class="e-post-img-h">
                                  <img id="e-img-preview">
                                </div>
                                <div class="e-p-close-img">
                                  <i class="material-icons" style="color:black">close</i>
                                </div>
                              </div>

                            </div>
                          </div>
                        </div>

                        <!-- =============================== Editing Post =============================== -->

                    </div>
                </div>


            </div>
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js" integrity="sha512-L03kznCrNOfVxOUovR6ESfCz9Gfny7gihUX/huVbQB9zjODtYpxaVtIaAkpetoiyV2eqWbvxMH9fiSv5enX7bw==" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script> <!-- To convert js time into djangotime-->
        <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
        <script src="{% static 'common.js' %}"></script>
        <script src="{% static 'otherserver.js' %}"></script>
        <script>
            const host_url = '{{ host_url }}';
            // grabbing credentials from localStorage
            const username = localStorage.getItem("username");
            const password = localStorage.getItem("pwd");
            const uuid  = localStorage.getItem("uuid");

            var followerArray = []; // uuid
            var friendsArray = []; // uuid
            var displayName_cur;
            var github_cur;
            const dname = localStorage.getItem('displayName');
            $('.username p').append(dname);

            function getLoginUser(){
                $.ajax({
                    type: 'GET',
                    url: 'author/'+localStorage.getItem('uuid')+'/'
                })
                .done(function(data){
                    console.log("USER CREDENTIALS");
                    console.log(data)
                    displayName_cur = data.displayName;
                    github_cur = data.github;
                    localStorage.setItem("git",github_cur);
                });
            }

            getLoginUser();

            // Added jquery for top container(new post)

            // hide top input bar
            $("#post-input").click(function(){
              loadFriendsToSelect();
              $("#post-input-w").hide();
              $("#post-container").show();

              // can only post if 'title' and 'content' have something
            });


            $(".close").click(function(){
              $("#post-input-w").show();
              $("#post-container").hide();
            });

            // Fetch all public posts
            // 0 meaning freshly pulled from db
            fetchMyPosts();

            // Fetch user's followers
            // with callback to fetchFriends
            fetchFollowers(fetchFriends);

            // $('#post-input').click(function() {
            //     document.getElementsByClassName("tab-switch")[0].style.visibility = "hidden";
            //     document.getElementsByClassName('post-format')[0].style.display = "block";
            // })
            $('#vis-input').click(function() {
                document.getElementsByClassName('vis-authors')[0].style.display = "block";

            })
            // $('.signin-act').click(function() {
            //     document.getElementsByClassName('popup-auth')[0].style.display = "none";
            //     window.location.href = host_url;
            //
            // })
            // $('.signup-act').click(function() {
            //     document.getElementsByClassName('popup-auth')[0].style.display = "none";
            //     window.location.href = host_url+"register";
            //
            // })

            // Local ONLY
            document.getElementsByClassName('tab-public')[0].classList.add("current-tab");
            $('.tab-public').click(function() {
                $('.posted-wrap').remove();
                document.getElementsByClassName('tab-inbox')[0].classList.remove("current-tab");
                document.getElementsByClassName('tab-public')[0].classList.add("current-tab");
                document.getElementsByClassName('nodiscoveries')[0].style.display = "none";
                fetchMyPosts();
                fetchFollowers(fetchFriends);
            })

            // FOREIGN ONLY
            $('.tab-inbox').click(function() {
              $('.posted-wrap').remove();
              document.getElementsByClassName('tab-public')[0].classList.remove("current-tab");
              document.getElementsByClassName('tab-inbox')[0].classList.add("current-tab");

              document.getElementsByClassName('nodiscoveries')[0].style.display = "block";
              document.getElementsByClassName('inbox-wrap')[0].style.display = "none";
              fetchFromOutsideServer();
            })

            // Markdown preview
            $('.post-preview').click(function() {
                $('.preview-body').empty();
                document.getElementsByClassName("post-body")[0].style.display = "none"; // hide other tab
                document.getElementsByClassName("preview-body")[0].style.display = "block"; // show current preview tab
                var text = document.getElementById('p-r-text-input').value;
                //convert markdown to html
                var converter = new showdown.Converter();
                var out = converter.makeHtml(text);
                document.getElementsByClassName('preview-body')[0].innerHTML += out;

            });

            $('.post-raw').click(function() {
                $('.preview-body').empty();
                $('.preview-body').hide();
                $('.post-body').show();

            });
            // $('.close').click(function() {
            //     document.getElementsByClassName('post-format')[0].style.display = "none";
            //     document.getElementsByClassName("tab-switch")[0].style.visibility = "visible";
            // });

            var openedcomments = [];
            function toggleComments(element){
                console.log(element)
                var commentblockid = "o-comment_"+element.id;
                if(!(openedcomments.includes(commentblockid))){
                    openedcomments.push(commentblockid);
                    document.getElementById(commentblockid).style.display = "inline-block";
                    console.log("comment opened")
                    console.log(openedcomments)
                    fetchcomment(element)
                }else{
                    const index = openedcomments.indexOf(commentblockid);
                    if (index > -1) {
                        openedcomments.splice(index, 1);
                    }
                    console.log(openedcomments)
                    document.getElementById(commentblockid).style.display = "none";
                    console.log("comment closed")
                }
            }

            var is_checked_listed = false;
            $('#checklist_listed').click(function() {
                if(!is_checked_listed){
                    document.getElementById('ch-listed').style.display = "flex";
                    is_checked_listed = true;
                }else{
                    document.getElementById('ch-listed').style.display = "none";
                    is_checked_listed = false;
                }
            });
            var postVisibility;
            var is_checked_friend = false;
            $('#vis-friends').click(function() {
                if(!is_checked_friend){
                    document.getElementById('ch-friends').style.display = "flex";
                    is_checked_friend = true;
                    postVisibility = "FRIENDS";
                }else{
                    document.getElementById('ch-friends').style.display = "none";
                    is_checked_friend = false;
                }
            });

            var is_checked_pub = false;
            $('#vis-pub').click(function() {
                if(!is_checked_pub){
                    document.getElementById('ch-pub').style.display = "flex";
                    is_checked_pub = true;
                    postVisibility = "PUBLIC";
                }else{
                    document.getElementById('ch-pub').style.display = "none";
                    is_checked_pub = false;
                }
            });

            // called when create post div opens
            function loadFriendsToSelect(){
              console.log('fA', friendsArray);
              for (id of friendsArray){
                $.ajax({
                type: 'GET',
                async: false,
                url: host_url + 'author/'+ id,
                })
                .done(function(data){
                  // Adding friends to select
                  $('#whichFriend').append(`<option value="${data.id}">
                                             ${data.displayName}
                                            </option>`);
                });
              }
            }



            // Adding image
            var base64 = '';
            var imgType;
            $('#img-input').change(function () {
                selectedFile = event.target.files[0];
                console.log(selectedFile)
                var imageType = /image.*/;
                if (selectedFile.type.match(imageType)) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        base64 = e.target.result;
                        imgType = selectedFile.type;
                        $('.p-close-img').css("display", "inline-block"); // shows closing button
                        $('#img-preview').attr('src', e.target.result);// shows image preview
                    };
                    reader.readAsDataURL(this.files[0]);

                }
            });

            // Removing image
            $('.p-close-img').click(function() {
                $('.p-close-img').css("display", "none"); // hide closing button
                $('#img-preview').attr('src', "");// hide image preview
                base64 = '';
                imgType = '';
            });

            // Making sure we can select All or friend iff FRIENDS
            $("#visibility_choice").change(function() {
              if(document.getElementById("visibility_choice").value == "FRIENDS")
                $('#whichFriend').removeAttr('disabled');
              else{
                $('#whichFriend').attr('disabled', 'disabled');
                $('#whichFriend').val('ALL');
                }
            })

             // Creating new post
             $('.create-post').click(function() {
                var title = document.getElementById("p-title").value;
                var text = document.getElementById("p-r-text-input").value;
                var listed_unlisted = document.getElementById("unlisted_listed").value;
                const whichFriend = document.getElementById("whichFriend").value;
                var description;
                // if categories empty, return array with "none"
                const categories = document.getElementById("p-cat").value.split(",")[0] == "" ? ["none"] : document.getElementById("p-cat").value.split(",");

                const data = {
                    'title':title,
                    'description':'',
                    'contentType':$('#content_type').val(),
                    'content':'',
                    'categories':categories,
                    'pageSize':1,
                    'visibility':$('#visibility_choice').val(),
                    'unlisted': listed_unlisted == "Unlisted"  // needs a js boolean
                };

                // just text
                if (!base64){
                  data.description = "text"
                  data.content = text;
                  makeReq(data); // post to user
                  if (data.visibility == "FRIENDS")
                    makeReqInbox(data, whichFriend)
                }

                // just image
                else if (base64 && !text.length){
                  data.description =  "img"
                  data.content = base64;
                  data.contentType = imgType + ";base64";
                  makeReq(data);
                  if (data.visibility == "FRIENDS")
                    makeReqInbox(data, whichFriend)
                }

                // image + text
                // 2 posts requests
                else if(base64  && text.length){
                  // generate an id common to both
                  const ra = Math.floor(Math.random() * 100);

                  // send text
                  data.description = "img+text+"+ra;
                  data.content = text;
                  makeReq(data);
                  if (data.visibility == "FRIENDS")
                    makeReqInbox(data, whichFriend)

                  // send image
                  data.content = base64;
                  data.contentType = imgType + ";base64";
                  makeReq(data);
                  if (data.visibility == "FRIENDS")
                    makeReqInbox(data, whichFriend)
                }

                console.log(data)

                function makeReq(data){
                  console.log(data);
                  $.ajax({
                  type: 'POST',
                  headers: {
                      'Authorization': 'Basic ' + btoa(username+':'+password),
                      'Content-Type': 'application/json',
                  },
                  url: host_url + 'author/'+localStorage.getItem('uuid')+'/posts/', // TODO: should point to current user url
                  data: JSON.stringify(data),
                  })
                  .done(function(data){
                    // hidind
                    $("#post-input-w").show();
                    $("#post-container").hide();

                    location.reload();
                  });
                }

                // whichFriend can be "ALL" or uuid of user
                function makeReqInbox(data, whichFriend){
                  // send only to Friends
                  if(whichFriend == "ALL"){
                    for(id of friendsArray)
                      makeReqInboxOne(id);
                  }

                  // send only to 1 Friend
                  else
                    makeReqInboxOne(whichFriend);
                }

                // sending post to id's inbox(1)
                function makeReqInboxOne(id){
                  const one_data = {
                     "type":                  "post",
                     "title":                 data.title,
                     "description":           data.description,
                     "source":                host_url,
                     "origin":                host_url,
                     "contentType":           data.contentType,
                     "content":               data.content,
                     "categories" :           data.categories,
                     "commentLink":           host_url,
                     "commentCount":          "0",
                     "pageSize":              "5",
                     "visibility":            data.visibility,
                     "unlisted":              data.unlisted,
                     "author":{
                       "author_id":           localStorage.getItem('uuid'),
                       "type":                "author",
                       "host":                host_url,
                       "displayName":         displayName_cur,
                       "url":                 host_url+'/author/'+localStorage.getItem('uuid'),
                       "github":              github_cur,
                       }
                  };

                  console.log('to inbox', one_data);
                  $.ajax({
                  type: 'POST',
                  headers: {
                      'Authorization': 'Basic ' + btoa(username+':'+password),
                      'Content-Type': 'application/json',
                  },
                  url: host_url + 'author/'+ id +'/inbox/',
                  data: JSON.stringify(one_data),
                  })
                  .done(function(data){
                    console.log('done');
                  });
                }

            });

            // callback to fetchFriends
            function fetchFollowers(ff){
                //fetch followers of user and cross check with post in order to add "follow" feature to post
                // also used to send post to Friends
                $.ajax({
                    type: 'GET',
                    url: host_url + 'author/'+localStorage.getItem('uuid')+'/followers/'
                })
                .done(function(data){
                    const followersRes =  data.items;
                    for(i=0;i < followersRes.length; i++){
                        followerArray.push(followersRes[i].id.split('/')[4])
                    }
                    // used for sending posts to 1 friend
                    ff(followerArray);
                });
            }

            function fetchFriends(followerArray){
              for(f_id of followerArray){
                $.ajax({
                type: 'GET',
                async: false,
                headers: {
                    'Authorization': 'Basic ' + btoa(username+':'+password),
                    'Content-Type': 'application/json',
                },
                url: host_url + 'author/'+localStorage.getItem('uuid')+'/followers/'+f_id+'/',
                })
                .done(function(data){
                  if(data.friends){
                    console.log('friend found');
                    friendsArray.push(f_id);
                  }
                });
              }
            }

            async function fetchMyPosts(){
              let response = await fetch(host_url + 'posts/',{
                  method: 'GET', // *GET, POST, PUT, DELETE, etc.
                  });

              let posts = await response.json();

              let iposts_res = await fetch(host_url + 'author/'+ uuid +'/inbox/',{
                  method: 'GET', // *GET, POST, PUT, DELETE, etc.
                  // credentials: 'same-origin', // include, *same-origin, omit
                  headers: {
                      'Authorization': 'Basic ' + btoa(username+':'+password),
                  },
                  // body: JSON.stringify(data) // body data type must match "Content-Type" header
                  });

              let iposts = await iposts_res.json();

              // get just the elements
              posts = posts.items ;

              // concatenate
              for(p of iposts.items){
                if(p.type == "post")
                  posts.push(p)
              }

              // sorting
              console.log(posts)
              for(i of posts) console.log(i.published)
              posts = posts.sort((a, b) => a.published + b.published)

              console.log("by FETCH", posts)

              for ( i = 0 ; i < posts.length; i++){
                  var data = posts[i];
                  var followFlag;
                  var delFlag;
                  var editFlag;

                  // if post belongs to a follower
                  if(followerArray.includes(data.author.id)){
                      followFlag="hideFollow"
                  }else{
                      followFlag="showFollow"
                  }

                  // if post belongs to logged in user
                  if(data.author.id == localStorage.getItem('uuid')){
                      flag="hideFollow";
                      delFlag = "unhideDel";
                      editFlag="unhideEdit";
                  }else{
                      delFlag= "hideDel";
                      editFlag="hideEdit";
                  }


                  var followstats = "nothing";
                  var like_c = 0;

                  // getting like count
                  let likes_res;
                  if(data.visibility == "PUBLIC"){
                    likes_res = await fetch('author/'+data.author_id+'/posts/'+data.post_id +"/likes",{
                        method: 'GET', // *GET, POST, PUT, DELETE, etc.
                        });
                    like_c = await likes_res.json();

                  } else {
                    // likes_res = await fetch('author/'+data.author.author_id+'/posts/'+data.notif_id +"/likes",{
                    //     method: 'GET', // *GET, POST, PUT, DELETE, etc.
                    //     });
                    like_c = {"type": "liked", "items":[]}; // TODO: dummy
                  }

                  console.log(like_c);
                  like_c = like_c.items.length;

                  // getting followstats

                  // console.log(data);
                  let followstats_res = await fetch(host_url + 'author/'+localStorage.getItem('uuid')+'/followers/'+data.author.id,{
                      method: 'GET', // *GET, POST, PUT, DELETE, etc.
                      });

                  // console.log(data.author.id == localStorage.getItem('uuid'))
                  followstats = await followstats_res.json();
                  followstats = followstats.accepted;
                  if(followstats == true){
                      followstats=""; // show nothing
                  }else if (followstats == false){
                      followstats="Request Sent";
                  }else if (data.author_id == localStorage.getItem('uuid')){ // current author
                      followstats="";
                  }else{
                      followstats="Follow";
                  }

                  FillDOM(data,followFlag,delFlag,editFlag, like_c, followstats);
                }

            }

            var arrayOfRequests = [];
            function checkFollowrequest(){
                $.ajax({
                    type: 'GET',
                    url: host_url + 'author/'+localStorage.getItem('uuid')+'/inbox/'
                })
                .done(function(data){
                    console.log(data)
                    console.log("IN check follow request");
                    var requests = data.items;
                    for(i=0;i < requests.length; i++){
                        arrayOfRequests.push(requests[0].id)
                    }
                });
            }

            // Append posts to DOM
            function FillDOM(data,flag,deleteFlag,editFlag, like_c, followstats){
              // we ASSUME that we are receiving posts in the correct order
              // For description with img+text, they are consecutive
              // Append the first one and skip the next one
              var image = '';
              var content = '';

              // only text
              // TODO: Markdown
              if(data.contentType == "text/plain" || data.contentType == "text/markdown"){
                content = data.content;
              }

              // one image
              else if(data.contentType == "application/base64"){
                image = `
                  <div class="posted-img-wrap">
                      <img src="${data.content}" id="proimage">
                  </div>
                `;
              }

              // text + image
              else if(data.contentType == "image/png;base64" || data.contentType == "image/jpeg;base64"){
                content = '';
                image = `
                  <div class="posted-img-wrap">
                      <img src="${data.content}" id="proimage">
                  </div>
                `;
              }

              // use appropirate format for markdown
              if(data.contentType == "text/markdown"){
                var converter = new showdown.Converter();
                content = converter.makeHtml(data.content);
              }

              const postHTML =  `<div class="posted-wrap">
                  <div class="posted-w-h" >
                      <div class="p-w-h-details">

                          <div class="p-profile-wrap">
                              <div class="p-profile">
                              </div>
                          </div>
                          <div class="p-user-wrap">
                              <p>${data.author.displayName}</p>
                          </div>
                          <p class="follow-user ${data.author.id}" id="${flag}" onclick="followUser(this)">${followstats}</p> <p class="post-type">${data.visibility}</p>
                      </div>
                      <div class="del-post ${deleteFlag}"  id="${data.post_id}" onclick="deletePost(this)">
                          <i class="material-icons" style="color:rgba(0,0,0,0.45)">delete_outline</i>
                      </div>
                      <div class="edit-post ${editFlag}" data-id="${data.post_id}" onclick="openEditPostPopup(this)">
                          <i class="material-icons" style="color:rgba(0,0,0,0.45)">mode</i>
                      </div>
                  </div>
                  <div class="p-title-wrap">
                      <p>${data.title}</p>
                  </div>

                  <div class="post-text">
                      <p>${content}</p>
                  </div>

                  <div class="posted-img-wrap">
                    ${image}
                  </div>

                  <div class="like-count-w">
                      <p id="like-count" class="${"like_row"+data.post_id}">${like_c + " likes"}</p><p id="${"comment-count_"+data.post_id}">${data.commentCount} comments</p">
                  </div>
                  <div class="social-controls">

                      <div class="like-w ${"thumb_"+data.author.id}" onclick="likepost(this)" id="${"thumb_"+data.post_id}">
                          <div class="s-c-img">
                              <i class="material-icons">thumb_up</i>
                          </div>
                          <p>Like</p>
                      </div>
                      <div class="comment-w" onclick="toggleComments(this)" id="${data.post_id}">
                          <div class="s-c-img">
                              <i class="material-icons">comment</i>
                          </div>
                          <p>Comment</p>
                      </div>

                      <div id="share-w">
                        <div id="share-w-w" data-pId=${data.post_id} data-authorId=${data.author.id}>
                            <div class="s-c-img">
                                <i class="material-icons">share</i>
                            </div>
                            <p>Share</p>
                        </div>
                        <div id="shareOptions">
                          <div class="share-sel-w">
                             <select  id="share-o-visibility">
                                <option value="PUBLIC">Public</option>
                                <option value="FRIENDS">Friends</option>
                              </select>
                          </div>
                          <div class="share-sel-w">
                            <select disabled id="share-o-whichFriend">
                               <option value="ALL">ALL</option>
                             </select>
                          </div
                          <div class="share-sel-w"><button class="share-btn">Share</button></div>
                        </div>
                      </div

                  </div>
                  <div class="o-comments" id="${"o-comment_"+data.post_id}">
                      <div class="o-c-cell">
                          <div class="oc-profile">

                          </div>
                          <div class="o-type-comment">
                              <input type="text" placeholder="Type your comments here" id="${"comment_input"+data.post_id}">
                          </div>
                          <div class="send-comment" onclick="addcomment(this)" id="${data.post_id}">
                              <i class="material-icons" style="color:white">send</i>
                          </div>
                      </div>
                      <div class="o-r-cell" id="${"comment_cell"+data.post_id}">

                      </div>
                  </div>
              </div>`;

              $(".post-feed").append(postHTML);

              // persistLikes(data.author.id, data.post_id, data,flag,deleteFlag,editFlag);
            }

            //likepost
            function likepost(element){
                var postid= (element.id).slice(6);

                ////get author id
                var arr = (element.className).split(' ');
                var extract = arr[1];
                fid = extract.slice(6);
                data = {
                    "type":"Like",
                    "author":{
                        'id':host_url+"author/"+localStorage.getItem('uuid'),
                        'type':'author',
                        'host':host_url,
                        'displayName':displayName_cur,
                        'url':host_url+"author/"+localStorage.getItem('uuid'),
                        'github':github_cur
                    },
                    "object":host_url+"author/"+fid+"/posts/"+postid
                }
                $.ajax({
                    type:"POST",
                    headers: {
                        'Authorization': 'Basic ' + btoa(username+':'+password),
                    },
                    contentType: "application/json",
                    data:JSON.stringify(data),
                    url: host_url + 'author/'+fid+'/inbox/'
                })
                .done(function(data){
                    //increment count
                    var countvaljunk = document.getElementsByClassName("like_row"+postid)[0].innerHTML += 1;
                    var countval = + countvaljunk.slice(0, -6)
                    countval+=1;
                    document.getElementsByClassName("like_row"+postid)[0].innerHTML = countval + " likes";
                })

            }


            function followUser(curTag){
                console.log("tapped follower tag")
                var arr = (curTag.className).split(' ');
                fid = arr[1];
                console.log(fid);
                followRequest(fid,curTag)

            }

            function followRequest(fid,curTag){
                data = {
                    "type":"Follow",
                    "actor":{
                        'id':host_url+"author/"+localStorage.getItem('uuid'),
                        'type':'author',
                        'host':host_url,
                        'displayName':displayName_cur,
                        'url':host_url+"author/"+localStorage.getItem('uuid'),
                        'github':github_cur
                    }

                }
                console.log(data)
                $.ajax({
                    type:"POST",
                    contentType: "application/json",
                    headers: {
                        'Authorization': 'Basic ' + btoa(username+':'+password),
                    },
                    data:JSON.stringify(data),
                    url: host_url + 'author/'+fid+'/inbox/'
                })
                .done(function(data){
                    //MANIPULATE DOM
                    console.log(data);
                    curTag.innerHTML = "Request Sent";
                    replaceall(fid)
                });
            }

            //replaces all follow request links of a particular user to "request sent"
            function replaceall(fid,curTag){
                $('.'+fid).each(function(i, obj) {
                    //test
                    obj.innerHTML = "Request Sent";
                });
            }


            // get number of likes of a post
            function persistLikes( author_id,post_id){
                // get a list of likes from other authors on current author’s post_id
                var dd = 0;
                $.ajax({
                    type: 'GET',
                    async: false,
                    url: 'author/'+author_id+'/posts/'+post_id +"/likes"
                })
                .done(function(d){
                    // console.log(d.items.length);
                    dd = d;
                });
                  return dd.items.length;
            }

            function persistFollowStats(authorId, fId){
                $.ajax({
                    type: 'GET',
                    async: false,
                    url: host_url + 'author/'+authorId+'/followers/'+fId
                })
                .done(function(dd){
                    var requestnotaccepted = dd.accepted;
                    var followstats;
                    if(requestnotaccepted == true){
                        followstats="accepted";
                    }else if (requestnotaccepted == false){
                        followstats="Request Sent";
                    }else{
                        followstats="Follow";
                    }
                    console.log(followstats);

                    return followstats;

                });
            }



            function deletePost(curDel){
                $.ajax({
                    type: 'DELETE',
                    headers: {
                        'Authorization': 'Basic ' + btoa(username+':'+password),
                    },
                    url: host_url + 'author/'+localStorage.getItem('uuid')+'/posts/'+curDel.id+'/',
                }).done(function(data){
                    // $('#'+curDel.id).parents('[class]:eq(1)').remove(); //get the first parent div wrapping the delete button
                    location.reload();
                    console.log('deleted');
                });
            }

            // Opens popup and fills data
            function openEditPostPopup(e){

              // closing popup if click is outside
              $(document).mouseup(function(e){
                console.log('clicked');
                var container = $(".e-editPostPopup");
                // if the target of the click isn't the container nor a descendant of the container
                if (!container.is(e.target) && container.has(e.target).length === 0){
                  container.hide();
                  $(document).off('mouseup'); //remove listener
                }
              });

              // open popup
              $(".e-editPostPopup").show();

              $.ajax({
                  type: 'GET',
                  headers: {
                      'Authorization': 'Basic ' + btoa(username+':'+password),
                  },
                  url: host_url + 'author/'+localStorage.getItem('uuid')+'/posts/'+e.dataset.id,
              })
              .done(function(d){
                console.log(d)
                $("#e-p-title").val(d.title);
                $("#e-p-description").val(d.description);
                $("#e-p-r-text-input").val(d.content);
                $("#e-content_type").val(d.contentType);
                $("#e-visibility_choice").val(d.visibility);
                if(d.unlisted)
                  $("#e-unlisted_listed").val("Unlisted");
                else
                  $("#e-unlisted_listed").val("Listed");
                $("#e-data-holder").data('source', d.source);
                $("#e-data-holder").data('origin', d.origin);
                $("#e-data-holder").data('commentLink', d.commentLink);
                $("#e-data-holder").data('commentCount', d.commentCount);
                $("#e-data-holder").data('id', d.post_id);

                // $("#").val(d.);
                // $("#e-one_friend").val(d.);
              });
            }

            // open share popu
            $(document).on('click', '#share-w-w', function() {

              const options = $(this).next("#shareOptions");
              options.show();

              $(document).mouseup(function(e){
                var container =  options;
                // if the target of the click isn't the container nor a descendant of the container
                if (!container.is(e.target) && container.has(e.target).length === 0){
                  container.hide();
                  $(document).off('mouseup'); //remove listener
                }
              });

              const pId = $(this).attr("data-pId");
              const authorId = $(this).attr("data-authorId");

              // getting post
              $.ajax({
                  type:"GET",
                  headers: {
                      'Authorization': 'Basic ' + btoa(username+':'+password),
                  },
                  url: host_url + 'author/'+authorId+'/posts/'+pId+'/'
              })
              .done(function(d){
                  //increment count
                  console.log(d);

                  // creating a new post
                  const data = {
                      'title':  d.title,
                      'description': 'shared',
                      'contentType': d.contentType,
                      'content': d.content,
                      'categories': d.categories,
                      'pageSize': d.pageSize,
                      'visibility': d.visibility,
                      'unlisted': d.unlisted,
                      "origin":d.origin,
                      // **could be different from origin if it is a share of a share
                       // “source”: “url of place your getting it from ”(string),
                       //else no need to include parameters for source and origin.
                  };

                  $(document).on('click', '.share-btn', function() {
                    console.log(data);
                    $.ajax({
                        type:"POST",
                        headers: {
                            'Authorization': 'Basic ' + btoa(username+':'+password),
                        },
                        contentType: "application/json",
                        data:JSON.stringify(data),
                        url: host_url + 'author/'+authorId+'/posts/'
                    })
                    .done(function(data){
                      console.log('post shared')
                      location.reload();
                      options.hide();
                    });
                  });

              });

            });

            // Disable/Enable select in Share popup
            $(document).on('click', '.share-sel-w', function() {
              const c = $(this).children("#share-o-visibility");
              if(c.val() == "FRIENDS")
                c.parent().next().children("#share-o-whichFriend").removeAttr('disabled');
              else{
                c.parent().next('.share-sel-w').children('#share-o-whichFriend').attr('disabled', 'disabled');
                c.parent().next('.share-sel-w').children('#share-o-whichFriend').val('ALL');
              }
            });

            $('.e-create-post').click(function() {
              var title = document.getElementById("e-p-title").value;
              var description = document.getElementById("e-p-description").value;
              var text = document.getElementById("e-p-r-text-input").value;
              var listed_unlisted = document.getElementById("e-unlisted_listed").value;
              // var cttn = base64 ? text : base64;
              var cttn = text;
              const postid = $("#e-data-holder").data('id');

              const data = {
                  'title':title,
                  'type': "post",
                  'description':description,
                  'contentType':$('#e-content_type').val(),
                  'content':cttn,
                  'categories':["web","tutorial"],
                  'pageSize':1,
                  'visibility':$('#e-visibility_choice').val(),
                  'unlisted': listed_unlisted == "Unlisted",  // needs a js boolean
                  'published': moment(Date()).format('YYYY-MM-DD HH:mm'),
                  'source': $("#e-data-holder").data('source'),
                  'origin': $("#e-data-holder").data('origin'),
                  'commentLink': $("#e-data-holder").data('commentLink'),
                  'commentCount': $("#e-data-holder").data('commentCount'),
              };
              console.log(data);

              $.ajax({
                  type: 'POST',
                  headers: {
                      'Authorization': 'Basic ' + btoa(username+':'+password),
                      'Content-Type': 'application/json',
                  },
                  url: host_url + 'author/'+localStorage.getItem('uuid')+'/posts/'+postid+'/',
                  data: JSON.stringify(data),
              })
              .done(function(d){
                $(".e-editPostPopup").hide();
                $(document).off('mouseup');
                location.reload();
              });

            });

            function closeEditFormPopup(){
              $(".e-editPostPopup").hide();
              $(document).off('mouseup');
            }


            //handlinf comments
            function addcomment(element){
                var pid = element.id;
                console.log(pid)
                var textfield = document.getElementById("comment_input"+pid).value;
                if(textfield == ""){
                    return
                }
                console.log(textfield)
                data = {
                    "type":"comment",
                    "author":{
                        'id':host_url+"author/"+localStorage.getItem('uuid'),
                        'type':'author',
                        'host':host_url,
                        'displayName':displayName_cur,
                        'url':host_url+"author/"+localStorage.getItem('uuid'),
                        'github':github_cur
                    },

                    "contentType":"text/plain",
                    "comment":textfield
                };

                $.ajax({
                    type:"POST",
                    headers: {
                        'Authorization': 'Basic ' + btoa(username+':'+password),
                    },
                    contentType: "application/json",
                    data:JSON.stringify(data),
                    url:host_url+"author/"+localStorage.getItem('uuid')+"/posts/"+pid+"/comments/"
                })
                .done(function(data){
                    //MANIPULATE DOM
                    console.log(data);

                    var c_cell = `<div class="o-r-details">
                        <p>${textfield}</p>
                        <div class="c-p-wrap">
                            <div class="comment-profile"> <i class="material-icons" style="color:cornflowerblue;">sentiment_satisfied_alt</i></div><p><span>${displayName_cur}</span></p>
                        </div>
                    </div>`;

                    $("#comment_cell"+pid).append(c_cell);
                    var commentlabel = document.getElementById("comment-count_"+pid).innerHTML;
                    var countvalarr = commentlabel.split(" ");
                    var countval;
                    countval = + countvalarr[0];
                    countval+=1;
                    console.log(commentlabel);
                    document.getElementById("comment_input"+pid).value = ""
                    document.getElementById("comment-count_"+pid).innerHTML = countval + " comments";

                    });
            }

            function fetchcomment(element){
                var pid = element.id;
                $.ajax({
                    type:"GET",
                    url:host_url+"author/"+localStorage.getItem('uuid')+"/posts/"+pid+"/comments/"
                })
                .done(function(data){
                    //MANIPULATE DOM
                    console.log(data.items);
                    getCommentlikes_local(data.items,element);
                });
            }

            function is_auth_user(){
                if(localStorage.getItem('uuid') == null){
                    //just view public post
                    return false;
                }else{
                    return true;
                }
            }

            async function getCommentlikes_local(data,element){
               for(i=0;i<data.length;i++){
                    console.log((data[i].author_id.url));
                  var clean_comment_id = data[i].comment_id;
                  var userid_clean;
                
                  if(data[i].author_id.host == "https://socialdistributionproject.herokuapp.com/"){
                       userid_clean = (data[i].author_id.url).split("/");
                       userid_clean = userid_clean[userid_clean.length - 2];
                  }else{
                      console.log((data[i].author_id.url));
                       userid_clean = (data[i].author_id.url).split("/");
                       userid_clean = userid_clean[userid_clean.length - 1];
                  }

                  console.log("--------");
                  console.log(clean_comment_id);
                  console.log(userid_clean);
                  try{
                      await $.ajax({
                          type: 'GET',
                          url:host_url+ 'author/'+userid_clean+'/posts/'+element.id+"/comments/"+clean_comment_id+"/likes/"
                      })
                      .done(function(commentarray){
                           console.log("inside comment array");
                           console.log(commentarray);

                               var comment = data[i].comment;
                               var commentlikes =  commentarray.items.length;
                               console.log(commentarray.items);

                               var c_cell = `
                               <div class="o-r-details">
                                   <p><span>${data[i].author_id.displayName}</span> ${comment}</p>
                                   <div class="c-p-wrap">
                                       <div class="comment-like-wrap ${userid_clean} ${clean_comment_id} ${element.id}" onclick="like_comment_local(this)"><p>Like</p></div><div class="comment-profile"><i class="material-icons" style="color:white;font-size:12px;">thumb_up</i></div><div class="comment-like-num"><p id="com-like_${clean_comment_id}">${commentlikes}</p></div><div class="comment-tzone"><p>${data[i].published.split("T")[0]}</p></div></div>
                                   </div>
                               </div>`;
                               $("#comment_cell"+element.id).append(c_cell);
                      });
                  }catch{

                  }
               }
          }

            //likepost
            function like_comment_local(element){

                   if (is_auth_user() == true){
                       console.log("like_post func called")
                       var post_owner_id = element.className.split(" ")[1];
                       var commentID = element.className.split(" ")[2];
                       var postID = element.className.split(" ")[3];

                       console.log("commenter id : "+post_owner_id);
                       console.log("comment id : "+commentID);
                       console.log("post id : "+postID);

                       data = {
                           "author_id":
                           {
                               "author_id":localStorage.getItem('uuid'),
                               "host":host_url,
                               "displayName":displayName_cur,
                               "url":host_url+"author/"+localStorage.getItem('uuid'),
                               "github":github_cur
                           }
                       }
                       $.ajax({
                           type:"POST",
                           contentType: "application/json",
                           headers: {
                               'Authorization': 'Basic ' + btoa(username+':'+password),
                           },
                           data:JSON.stringify(data),
                           url:host_url+"author/"+post_owner_id+"/posts/"+postID+"/comments/"+commentID+"/likes/"
                       })
                       .done(function(data){
                           //increment count
                           console.log(data);
                           var countvaljunk = document.getElementById("com-like_"+commentID).innerHTML;
                           var countval = + countvaljunk;
                           countval+=1;
                           document.getElementById("com-like_"+commentID).innerHTML = countval;
                       })

                   }else{
                       //alert("sign in or sign up to like a post");
                       document.getElementsByClassName('popup-auth')[0].style.display = "block";
                   }

           }





        </script>
    </body>
</html>
