{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet"  href="{%  static  'css/frame_.css'  %}">
    <link rel="stylesheet"  href="{%  static  'css/friends.css'  %}">
    <link href = "https://fonts.googleapis.com/css?family=Roboto+Mono|Roboto+Slab|Roboto:300,400,500,700" rel = "stylesheet" />
    <title>Search</title>

    <style>
      .user-w{
        font-size: 1.5em;
        margin-bottom: 10px;
        border-bottom: 1px solid #ded9d9;
        padding-bottom: 20px;

      }

      .follow-btn{
        display: inline-block;
        background-color: #2c9ef1db;
        padding: 5px;
        font-size: 0.7em;
        color: white;
        border-radius: 3px;
        cursor: pointer;
        margin-left: 20px;
      }

      .a_friends{
        display: inline-block;
        margin-left: 20px;
        background-color: gray;
        padding: 8px;
        border-radius: 5px;
        color: white;
      }
    </style>

</head>
<body>
   {% include "components/topnav.html" %}
    <div class="main-body">
        {% include "components/leftnav.html" %}

        <div class="content">
          <div class="" style="width:80%">
            <h1>Users</h1>
            <div id="main-container">

            </div>
          </div>

        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="{% static 'common.js' %}"></script>
    <script>

        const host_url = '{{ host_url }}';

        // grabbing credentials from localStorage
        const username = localStorage.getItem("username");
        const password = localStorage.getItem("pwd");
        const uuid  = localStorage.getItem("uuid");

        findUsers();
        // Get Local users
        async function findUsers(){
          let users_r = await fetch(host_url + 'author/',{
              method: 'GET', // *GET, POST, PUT, DELETE, etc.
              });

          let users = await users_r.json();

          for (u of users){

            // skip current user
            if(u.id != uuid){
              // check if we're friends
              let foll_r = await fetch(host_url + 'author/'+ uuid +'/followers/'+u.id,{
                  method: 'GET', // *GET, POST, PUT, DELETE, etc.
                  // credentials: 'same-origin', // include, *same-origin, omit
                  headers: {
                      'Authorization': 'Basic ' + btoa(username+':'+password),
                  },
                  // body: JSON.stringify(data) // body data type must match "Content-Type" header
                  });

              let fol = await foll_r.json();

              let tag = "";
              // if we're friends
              if(fol.friends){
                $("#main-container").append(`
                <div class="user-w">
                  ${u.displayName} <div class="a_friends">Already Friends</div>
                </div>
                `);
              } else { // if not, follow
                $("#main-container").append(`
                <div class="user-w">
                  ${u.displayName} <div class="follow-btn" data-id="${u.id}">Follow</div>
                </div>
                `);
              }

            }
          }

        }

        // Send Follow Request
        $('#main-container').on('click', '.follow-btn', function(){
            const f_id = $(this).data("id");
            // console.log(id)

            data = {
                "type":"follow",
                "actor":{
                    'id':host_url+"author/"+localStorage.getItem('uuid'),
                    'type':'author',
                    'host':host_url,
                    'displayName':localStorage.getItem('username'),
                    'url':host_url+"author/"+localStorage.getItem('uuid'),
                    'github':'github'
                }

            }

            $.ajax({
              type: 'POST',
              headers: {
                  'Authorization': 'Basic ' + btoa(username+':'+password),
              },
              data:JSON.stringify(data),
              contentType: "application/json",
              url: host_url + 'author/'+ f_id +'/inbox/',
            })
              .done(function(d){
                // TODO: Not working
                location.reload();
              });
        });

    </script>
</body>
</html>
